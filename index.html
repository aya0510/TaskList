<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Task Hub - Full History Edition</title>
    <style>
        :root { --high: #ef4444; --mid: #f59e0b; --low: #3b82f6; --bg: #f8fafc; --border: #e2e8f0; --primary: #1e293b; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .menu-toggle { display: none; position: fixed; top: 10px; left: 10px; z-index: 1000; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }

        .sidebar { width: 420px; min-width: 420px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; overflow-y: auto; transition: transform 0.3s ease; }
        .main-content { flex: 1; padding: 15px; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        .panel { background: white; padding: 15px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h2 { font-size: 0.8rem; color: var(--primary); margin: 0 0 10px 0; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        input, select, button { padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; }
        button { cursor: pointer; }
        button#add-btn { background: var(--primary); color: white; border: none; font-weight: bold; }

        .task-list { font-size: 13px; }
        .task-item { padding: 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; }
        .item-high { border-left-color: var(--high); }
        .item-medium { border-left-color: var(--mid); }
        .item-low { border-left-color: var(--low); }
        
        /* å…¨å±¥æ­´è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« */
        .history-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .history-content { background: white; width: 90%; max-width: 600px; height: 80vh; border-radius: 15px; display: flex; flex-direction: column; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .history-list { flex: 1; overflow-y: auto; margin-top: 15px; }

        .calendar-container { background: white; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); flex: 1; overflow-y: auto; }
        .day-name { background: #f8fafc; padding: 8px; text-align: center; font-weight: bold; font-size: 11px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
        .day-cell { min-height: 80px; padding: 2px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .day-num { font-size: 11px; color: #94a3b8; font-weight: bold; }
        .cal-tag { font-size: 9px; padding: 1px 2px; border-radius: 3px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid rgba(0,0,0,0.1); }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .menu-toggle { display: block; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; z-index: 999; transform: translateX(-100%); width: 85%; min-width: auto; }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 50px 10px 10px 10px; }
        }
    </style>
</head>
<body>

<button class="menu-toggle" onclick="toggleSidebar()">â˜° ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>

<div class="history-overlay" id="historyOverlay">
    <div class="history-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="border:none; margin:0;">ğŸ å®Œäº†ã‚¿ã‚¹ã‚¯å…¨å±¥æ­´</h2>
            <button onclick="toggleHistory()" style="background:none; border:none; font-size:20px;">âœ•</button>
        </div>
        <div id="fullHistoryList" class="history-list"></div>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div class="panel">
        <h2>â• ã‚¿ã‚¹ã‚¯ç™»éŒ²</h2>
        <div class="form-group">
            <input type="text" id="taskInput" placeholder="ã‚¿ã‚¹ã‚¯å">
            <div style="display:flex; gap:5px;">
                <input type="date" id="planDate" style="flex:1">
                <input type="date" id="deadline" style="flex:1">
            </div>
            <div style="display:flex; gap:5px;">
                <select id="taskCategory" style="flex:1"></select>
                <select id="priority" style="flex:1">
                    <option value="high">å„ªå…ˆï¼šé«˜</option>
                    <option value="medium" selected>å„ªå…ˆï¼šä¸­</option>
                    <option value="low">å„ªå…ˆï¼šä½</option>
                </select>
            </div>
            <button id="add-btn" onclick="addTask(); toggleSidebar();">ç™»éŒ²</button>
        </div>
    </div>

    <div class="panel" style="background: #fffbeb;">
        <h2>ğŸ”¥ ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</h2>
        <div id="todayList" class="task-list"></div>
    </div>
    
    <div class="panel">
        <h2 style="color: #64748b;">âœ… å®Œäº†æ¸ˆã¿ 
            <button onclick="toggleHistory()" style="font-size:10px; padding:2px 6px; background:white; color:var(--primary); border:1px solid var(--border);">å…¨å±¥æ­´ã‚’è¡¨ç¤º</button>
        </h2>
        <div id="doneList" class="task-list"></div>
    </div>

    <div class="panel" style="background: #f8fafc; border: 1px solid #1e293b;">
        <h2>ğŸŒ åŒæœŸãƒ»å¼•ã£è¶Šã—</h2>
        <button onclick="exportData()" style="width:100%; font-size:11px; margin-bottom:5px;">â‘  ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™</button>
        <textarea id="transferArea" style="font-size: 10px; width: 100%; height: 40px; background: #f1f5f9;"></textarea>
        <button onclick="importData()" style="width:100%; font-size:11px; background:#10b981; color:white; border:none; margin-top:5px;">â‘¡ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
    </div>
</div>

<div class="main-content">
    <div class="calendar-container">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">â—€</button>
            <h1 id="monthDisplay"></h1>
            <button onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
</div>

<script>
    let calDate = new Date();
    const TASK_KEY = 'BizTask_Tasks_vMobile';
    const CAT_KEY = 'BizTask_Cats_vMobile';

    function toggleSidebar() { if (window.innerWidth <= 768) document.getElementById('sidebar').classList.toggle('open'); }
    function toggleHistory() {
        const overlay = document.getElementById('historyOverlay');
        overlay.style.display = (overlay.style.display === 'flex') ? 'none' : 'flex';
        if(overlay.style.display === 'flex') renderHistory();
    }

    function getTasks() { return JSON.parse(localStorage.getItem(TASK_KEY) || '[]'); }
    function getCats() { return JSON.parse(localStorage.getItem(CAT_KEY) || '[{"id":"c1","name":"ä»•äº‹","color":"#dcfce7"}]'); }
    function saveAll(t, c) { if(t) localStorage.setItem(TASK_KEY, JSON.stringify(t)); if(c) localStorage.setItem(CAT_KEY, JSON.stringify(c)); }

    function addTask() {
        const title = document.getElementById('taskInput').value.trim();
        if (!title) return;
        const tasks = getTasks();
        tasks.push({
            id: Date.now(), title, plan: document.getElementById('planDate').value,
            limit: document.getElementById('deadline').value, catId: document.getElementById('taskCategory').value,
            priority: document.getElementById('priority').value, completed: false, completedDate: null
        });
        saveAll(tasks, null);
        document.getElementById('taskInput').value = '';
        refreshUI();
    }

    function updateStatus(id, isDone) {
        const tasks = getTasks();
        const t = tasks.find(t => t.id === id);
        if (t) {
            t.completed = isDone;
            t.completedDate = isDone ? new Date().toLocaleDateString('sv-SE') : null;
        }
        saveAll(tasks, null);
        refreshUI();
        if(document.getElementById('historyOverlay').style.display === 'flex') renderHistory();
    }

    function renderHistory() {
        const tasks = getTasks().filter(t => t.completed).sort((a,b) => b.id - a.id);
        const cats = getCats();
        const list = document.getElementById('fullHistoryList');
        list.innerHTML = tasks.length ? '' : '<p style="text-align:center; color:#94a3b8; font-size:13px;">å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        tasks.forEach(t => {
            const cat = cats.find(c => c.id === t.catId) || {name:'ãªã—', color:'#eee'};
            list.innerHTML += `<div class="task-item" style="background:#f1f5f9; border-left:none;">
                <div style="flex:1;">
                    <div style="font-size:12px; font-weight:bold;"><s>${t.title}</s></div>
                    <div style="font-size:10px; color:#64748b;">å®Œäº†æ—¥: ${t.completedDate || 'ä¸æ˜'} | ã‚«ãƒ†ã‚´ãƒª: ${cat.name}</div>
                </div>
                <button onclick="updateStatus(${t.id}, false)" style="font-size:10px; padding:4px 8px; background:white;">æœªå®Œäº†ã«æˆ»ã™</button>
            </div>`;
        });
    }

    function refreshUI() {
        const tasks = getTasks();
        const cats = getCats();
        const active = tasks.filter(t => !t.completed);
        const done = tasks.filter(t => t.completed).reverse().slice(0, 3);
        const todayStr = new Date().toLocaleDateString('sv-SE');

        // ã‚«ãƒ†ã‚´ãƒªåæ˜ 
        const catSelect = document.getElementById('taskCategory');
        catSelect.innerHTML = '';
        cats.forEach(c => catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

        // ãƒªã‚¹ãƒˆåæ˜ 
        document.getElementById('todayList').innerHTML = '';
        document.getElementById('doneList').innerHTML = '';
        
        active.forEach(t => {
            const cat = cats.find(c => c.id === t.catId) || { color: '#eee' };
            const html = `<div class="task-item item-${t.priority}" style="background:${cat.color}">
                <div style="flex:1"><strong>${t.title}</strong><div style="font-size:10px; opacity:0.7;">â° ${t.limit || '--'}</div></div>
                <button onclick="updateStatus(${t.id}, true)">âœ”</button>
            </div>`;
            if(t.plan === todayStr || t.limit === todayStr) document.getElementById('todayList').innerHTML += html;
        });

        done.forEach(t => {
            document.getElementById('doneList').innerHTML += `<div class="task-item" style="background:#f1f5f9; border-left:none; opacity:0.6;">
                <div style="flex:1; font-size:11px;"><s>${t.title}</s></div>
            </div>`;
        });

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» (ç°¡æ˜“)
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        const y = calDate.getFullYear(), m = calDate.getMonth();
        document.getElementById('monthDisplay').innerText = `${y}å¹´ ${m+1}æœˆ`;
        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m+1, 0).getDate();
        for(let i=0; i<first; i++) grid.innerHTML += `<div class="day-cell" style="background:#f9fafb"></div>`;
        for(let d=1; d<=last; d++){
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            let tHtml = `<span class="day-num">${d}</span>`;
            active.filter(t => t.plan === dStr || t.limit === dStr).forEach(t => {
                const cat = cats.find(c => c.id === t.catId) || { color: '#eee' };
                tHtml += `<div class="cal-tag" style="background:${cat.color}">${t.title}</div>`;
            });
            grid.innerHTML += `<div class="day-cell">${tHtml}</div>`;
        }
    }
    function changeMonth(n) { calDate.setMonth(calDate.getMonth() + n); refreshUI(); }
    function exportData() { document.getElementById('transferArea').value = btoa(encodeURIComponent(JSON.stringify({tasks:getTasks(), cats:getCats()}))); alert("æ›¸ãå‡ºã—ã¾ã—ãŸã€‚"); }
    function importData() { try { const d = JSON.parse(decodeURIComponent(atob(document.getElementById('transferArea').value))); saveAll(d.tasks, d.cats); refreshUI(); alert("å®Œäº†"); } catch(e){ alert("ã‚¨ãƒ©ãƒ¼"); } }
    
    refreshUI();
</script>
</body>
</html>
